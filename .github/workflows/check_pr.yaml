name: Debug Firebase Distribution

on:
  push:
  pull_request:

jobs:
  deploy-firebase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: jdx/mise-action@v3.6.1
        with:
          install: true

      - name: Install dependencies
        run: |
          flutter pub get
          cd android && bundle install

      - name: Generate Icons
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (-f) ã‚’æŒ‡å®šã—ãªã„å ´åˆã€pubspec.yaml å†…ã®è¨­å®šãŒä½¿ã‚ã‚Œã¾ã™
        run: dart run flutter_launcher_icons

      # ========================================================
      # ã€ãƒ‡ãƒãƒƒã‚°ã€‘ã‚¢ã‚¤ã‚³ãƒ³ãŒã©ã“ã«ã‚ã‚‹ã‹ã€ç‰©ç†çš„ãªå­˜åœ¨ã‚’ç¢ºèªã™ã‚‹
      # ========================================================
      - name: Check Generated Icon Files
        run: |
          echo "ðŸ”Ž Searching for ic_launcher.png in android/app/src..."
          find android/app/src -name "ic_launcher.png"
          echo "----------------------------------------"
          echo "ðŸ“ Listing directories in src/main/res and src/prod/res (if exists):"
          ls -R android/app/src/main/res/mipmap-* 2>/dev/null || echo "No mipmap folders in main"
          ls -R android/app/src/prod/res/mipmap-* 2>/dev/null || echo "No mipmap folders in prod"
      # ========================================================

      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=define/prod.json

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: cd android && bundle exec fastlane firebase